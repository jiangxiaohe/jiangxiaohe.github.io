---
layout: post
title: 高效检索库facebookresearch/faiss
tags:
categories: deepLearning
description:
---

[facebookresearch/faiss](https://github.com/facebookresearch/faiss)

# 简介

Faiss是一个用于高效相似性搜索和密集向量聚类的库。它包含搜索任意大小的向量集的算法，最多可能不适合RAM。

# 相似性搜索

np提供的函数`np.argmin(a,axis=None,out=None)`可以找到输入数组a的anis轴上最小值的索引。

给定维度d中的一组向量x_i，Faiss从中构建数据结构。在构造结构之后，当给定维度为d的新向量x时，它有效地执行操作：

$i = argmin_i || x - x_i ||$

这里用的是L2距离（平方求和再开放）

* Faiss可以返回K个最近邻
* Faiss一次搜索几个向量而不是一个（批处理）。对于许多索引类型，这笔搜索一个接一个的矢量更快。
* 执行最大内积搜索(maximum inner product search)而不是最小欧几里得搜索(minimum Euclidean search)
* 返回查询点的给定半径范围内的所有元素

# Faiss最值得注意实现成果
## Video Google: a text retrieval approach to object matching in videos
## Product Quantization for Nearest Neighbor Search
## SEARCHING IN ONE BILLION VECTORS: RE-RANK WITH SOURCE CODING
## The inverted multi-index
## Optimized Product Quantization

# 入门

## 安装

查看facebookresearch/faiss/blob/master/INSTALL.md和faiss/wiki/Getting-started

最简单的方式使用conda安装，在Linux和OSX上都支持faiss-cpu。在Linux系统上提供了使用CUDA8 / CUDA9 / CUDA10编译的faiss-gpu

我安装是GPU的CUDA9版本

`conda install faiss-gpu cudatoolkit=9.0 -c pytorch # For CUDA9`

## python例程

```python
# 获取数据
import numpy as np
d = 64                           # dimension
nb = 100000                      # database size
nq = 10000                       # nb of queries
np.random.seed(1234)             # make reproducible
xb = np.random.random((nb, d)).astype('float32')
xb[:, 0] += np.arange(nb) / 1000.
xq = np.random.random((nq, d)).astype('float32')
xq[:, 0] += np.arange(nq) / 1000.

# 构建索引并向其添加向量

import faiss            # make faiss available
index = faiss.IndexFlatL2(d)   # build the index
print(index.is_trained)
index.add(xb)                  # add vectors to the index
print(index.ntotal)

# 搜索
k = 4                          # we want to see 4 nearest neighbors
D, I = index.search(xb[:5], k) # sanity check
print(I)
print(D)
# I表示k个最近邻的索引，D表示相应的L2距离
# 输出结果：
'''
[[  0 393 363  78]
 [  1 555 277 364]
 [  2 304 101  13]
 [  3 173  18 182]
 [  4 288 370 531]]

[[ 0.          7.17517328  7.2076292   7.25116253]
 [ 0.          6.32356453  6.6845808   6.79994535]
 [ 0.          5.79640865  6.39173603  7.28151226]
 [ 0.          7.27790546  7.52798653  7.66284657]
 [ 0.          6.76380348  7.29512024  7.36881447]]
'''
D, I = index.search(xq, k)     # actual search
print(I[:5])                   # neighbors of the 5 first queries
print(I[-5:])                  # neighbors of the 5 last queries
# 输出结果：
'''

'''
```

如果实际搜索时报错`Intel MKL FATAL ERROR: Cannot load libmkl_avx2.so or libmkl_def.so.`

Intel MKL，全称 Intel Math Kernel Library，提供经过高度优化和大量线程化处理的数学例程，面向性能要求极高的科学、工程及金融等领域的应用。MKL是一款商用函数库，提供C、Fortran 和 Fortran 95的支持，但仅支持Intel自家旗下的CPU。

深入理解该示例：
https://blog.csdn.net/kanbuqinghuanyizhang/article/details/80774609
https://waltyou.github.io/Faiss-In-Project/
https://waltyou.github.io/Faiss-Indexs/#%E6%8C%91%E4%B8%80%E4%B8%AA%E5%90%88%E9%80%82%E7%9A%84-index


暂未解决

# faiss应用
