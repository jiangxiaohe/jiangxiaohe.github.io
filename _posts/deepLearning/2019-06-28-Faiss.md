---
layout: post
title: 高效检索库facebookresearch/faiss
tags:
categories: deepLearning
description:
---

[facebookresearch/faiss](https://github.com/facebookresearch/faiss)
[C++官方类文件说明](https://rawgit.com/facebookresearch/faiss/master/docs/html/annotated.html)
[官网中文简略翻译](https://www.cnblogs.com/yhzhou/p/10568728.html)

# 简介

Faiss是一个用于高效相似性搜索和密集向量聚类的库。它包含搜索任意大小的向量集的算法，最多可能不适合RAM。

# 相似性搜索

np提供的函数`np.argmin(a,axis=None,out=None)`可以找到输入数组a的anis轴上最小值的索引。

给定维度d中的一组向量x_i，Faiss从中构建数据结构。在构造结构之后，当给定维度为d的新向量x时，它有效地执行操作：

$i = argmin_i || x - x_i ||$

这里用的是L2距离（平方求和再开放）

* Faiss可以返回K个最近邻
* Faiss一次搜索几个向量而不是一个（批处理）。对于许多索引类型，这笔搜索一个接一个的矢量更快。
* 执行最大内积搜索(maximum inner product search)而不是最小欧几里得搜索(minimum Euclidean search)
* 返回查询点的给定半径范围内的所有元素

# Faiss最值得注意实现成果
## Video Google: a text retrieval approach to object matching in videos
## Product Quantization for Nearest Neighbor Search
## SEARCHING IN ONE BILLION VECTORS: RE-RANK WITH SOURCE CODING
## The inverted multi-index
## Optimized Product Quantization

# [C++编译安装](https://github.com/facebookresearch/faiss/blob/master/INSTALL.md)

1. `./configure`命令，生成`makefile.inc`文件
  *  `./configure --without-cuda`CPU版本
  *  `./configure --with-cuda=/path/to/cuda` 加入cuda路径。
  * ./configure 是用来检测你的安装平台的目标特征的。比如它会检测你是不是有CC或GCC，并不是需要CC或GCC，它是个shell脚本。
2. `make`命令，生成静态链接库`.a`和动态链接库`.so`
  * gpu版本报错信息`nvcc fatal : unsupported gpu architecture 'compute 75'`。需要编辑上一步生成的`makefile.inc`文件，注释掉`-gencode=arch=compute_75,code=compute_75`这一行
  * make 是用来编译的，它从Makefile中读取指令，然后编译
3. make install
* make install是用来安装的，它也从Makefile中读取指令，安装到指定的位置。
4. make py
遇到错误信息如下：
编译cpu版本：configure: error: An implementation of BLAS is required but none was found.

尝试的解决过程（未解决）：
faiss仅有的两个依赖包：blas和lapack

sudo apt-get install libblas-dev checkinstall
sudo apt-get install libblas-doc checkinstall
sudo apt-get install liblapack-dev checkinstall
sudo apt-get install liblapack-doc checkinstall

报错找不到swingfaiss.cpp文件

需要安装swig：
sudo apt-get install swig

之后提示：
cc1plus: warning: /usr/bin/python2.7: not a directory
cc1plus: warning: /usr/bin/python2.7: not a directory
swigfaiss.cpp:171:21: fatal error: Python.h: 没有那个文件或目录

多数情况下安装Python2.7-dev可以解决
sudo apt-get install python2.7-dev

然后在108上还是不可以

在99服务器上：还是不可以，我已经绝望了

# python安装

查看facebookresearch/faiss/blob/master/INSTALL.md和faiss/wiki/Getting-started

最简单的方式使用conda安装，在Linux和OSX上都支持faiss-cpu。在Linux系统上提供了使用CUDA8 / CUDA9 / CUDA10编译的faiss-gpu

我安装是GPU的CUDA9版本

`conda install faiss-gpu cudatoolkit=9.0 -c pytorch # For CUDA9`

# getting started

* https://blog.csdn.net/kanbuqinghuanyizhang/article/details/80774609
* https://github.com/facebookresearch/faiss/wiki/Getting-started

```python

```

# [Faiss Index](https://waltyou.github.io/Faiss-In-Project/)

Index是Faiss中的索引，Faiss不关心特征的提取，只关心为特征建立索引。

常见的图片特征如下：

![](https://waltyou.github.io/images/posts/image-feature-extration-algorithm.png)

[如何选取合适的Index？](https://waltyou.github.io/Faiss-Indexs/#%E6%8C%91%E4%B8%80%E4%B8%AA%E5%90%88%E9%80%82%E7%9A%84-index)

## Flat
保证精确结果的唯一索引是 IndexFlatL2，为其他索引的结果提供基线。

它不压缩向量，但不会在它们之上增加开销。

它不支持添加id（add_with_ids），只支持顺序添加，因此如果需要 add_with_ids，请使用“IDMap,Flat”。

是否支持 GPU： yes

## HNSW



# C++编译安装
未成功
不知道如何修改.config文件


# faiss应用
