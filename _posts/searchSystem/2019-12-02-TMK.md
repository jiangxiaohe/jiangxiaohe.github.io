# TMK算法

本文是[hashing.pdf](https://github.com/facebook/ThreatExchange/tree/master/hashing)的阅读总结，主要阅读了TMK视频匹配算法部分。这个库于2019年8月1日开源。

TMK+PDQF and PDQ are syntactic rather than semantic hashers. （syntactic语法，semantic语义，后者更加高级）

Semantic hashers include various machine-learning techniques, such as those in use at Facebook; syntactic hashers alongside PDQ include pHash , aHash, dHash, and GIST, all of which are discussed in this document.

PDQ：一种图片hash算法，用0-100的质量级别来度量细节的质量，汉明距离的256位。（我理解为是256位的01字符串）PDQ的hash速度很快，运行速度与磁盘读取速度大致相同。

TMK+PDQF：视频hash算法。用PQDF算法（实际上是PDQ算法去除了最后的二进制量化的步骤），使用TMK算法本身来收集有关帧的时间信息。TMK + PDQF可以以很高的视频回放速度运行-可能达到30倍，具体取决于存储密度。

## TMK特征

TMK (for Temporal Match Kernel) is a video-similarity-detection algorithm. It produces fixed-length video hashes (on the order of 256KB).

TMK产生固定长度的视频散列（256kB）。

TMK可以检测到的视频变化类型有：播放速度、文件格式、像素分辨率的变化，以及小的修改，具体包括浅水印、插入/删除短的头尾序列。
TMK算法检测不到adversarially modified videos，比如裁剪、加边框、较大的标志。

TMK+PDQF在整个视频上操作，可以检测2分钟的视频加了或者减去5秒的视频，但是不能检测到1小时的视频增加或者减去了2分钟。该算法仅是一个内容匹配的组件。

TMK视频hash的大小和视频长度无关，取决于PDQF每一帧的特征大小，如果是256个浮点数，则TMK特征大小为256kB，如果是512个浮点数，则为512kB。

## PDQ特征

PDQ被设计用来匹配匹配相似图片，used for lightly(non-adversarially) modified images.
PDQ has been found to tolerate light watermarking / logo placement.
does not do well at pairing photos one of which is a crop of another.

## TMK算法

算法的步骤如下：给定一个视频
1. 每秒提取15帧
2. 对每一帧生成256维浮点数向量
   1. 计算各个周期的cos/sin加权的元素均值
   2. PDQF为每个帧生成一个256个元素的向量，因此每个临时化的特征也是一个256个元素的向量。 例如，时隙37是视频所有帧上时隙37的时间加权平均值。
3. 输出
   1. 所有帧特征的未加权平均值称为1级特征。
   2. 不同的加权平均值的组合称为2级特征。使用余弦和正弦、不同的周期、不同的傅立叶权重。
   3. 处理完所有帧后，每个特征都是L2归一化的； 然后，2级特征是由选定的傅立叶权重加权。
4. 文件类型
   1. IEEE浮点数4字节。PDQF生成256个浮点数，我们用正弦和余弦权重、4个不同的周期、32个不同的傅立叶权重。1级特征的大小为1KB，2级特征的大小为2*4*32*256*4B=256KB。
   2. 元数据包括（文件类型标示符、四个周期、傅立叶权重、level-1特征、level-2特征），保存到tmk文件当中

给定一对tmk文件，比较相似度
1. 首先比较level1特征的余弦相似度，称为level-1匹配分数。完美匹配分数为1，最小值为-1.这种匹配很快，并且适合用索引系统，比如FAISS。
2. 当1级对分数在阈值之内时，才比较两个tmk文件的2级特征，称为2级匹配分数。 完美匹配1.0，最小值为0.0。FAISS无法为2级对得分打分。

TMK算法的实现细节要查看论文[Temporal Matching Kernel with Explicit Feature Maps](https://hal.inria.fr/hal-01842277/document)

# TMK算法细节



# 代码测试